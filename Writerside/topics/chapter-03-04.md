# 3.4 多帧滑动窗口与后退 N 帧协议

发送方维护一个**发送窗口**，其大小 $W_s$ 满足 $1 \leq W_s < 2^n$，其中 $n$ 为帧序号的位数。

接收方维护一个**接收窗口**，其大小固定为 1。

当上层（即网络层）需要发送数据时，发送方先检查发送窗口是否已满，如果未满，则产生一个帧并将其发送；若窗口已满，则向上层回报，要求其稍后再试。

当接收方正确接收到了一个帧时，检查帧的序号是否为所期望接收到的帧序号 $k$，如果是则上交网络层，并向发送方发送确认帧 ACK 确认需要 $k+1$，如果不是则直接**丢弃**。

发送方维护一个超时计时器，在发送窗口内所有帧发送完成后，记当前发送窗口最后一个帧的序号为 $k$，并启动超时计时器。当发送方收到接收方序号为 $i$ 的确认帧时，将发送窗口前沿移动至序号 $i$。若计时器超时前收到了帧序号为 $k+1$ 的确认，则继续发送发送窗口内的帧；若计时器超时仍未收到帧序号为 $k+1$ 的确认，则重传当前发送窗口中的所有帧。

具体的：

表格中例如 `[123]` 表示当前窗口包含的帧的序号。

| 发送窗口  | 发送方                                                                                 | 接收方                                           | 接收窗口 |
|-------|-------------------------------------------------------------------------------------|-----------------------------------------------|------|
| [---] | 维护一个大小为 3 的发送窗口                                                                     | 维护一个大小固定位 1 的接收窗口                             | [-]  |
| [012] | 发送序号为 0 ~ 2 的帧，记录当前已发送的最后一个帧序号为 2，并启动超时计时器                                          |                                               | [0]  |
| [012] |                                                                                     | 收到序号为 0 的帧                                    | [0]  |
| [012] |                                                                                     | 序号为 0 的帧校验正确，向发送方发送序号为 1 的 ACK 确认帧，并移动接收窗口    | [1]  |
| [123] | 收到序号为 0 的确认帧，移动发送窗口前沿至序号 1                                                          |                                               | [1]  |
| [123] |                                                                                     | 收到序号为 1 的帧                                    | [1]  |
| [123] |                                                                                     | 未能正确接收序号为 1 的帧，丢弃                             | [1]  |
| [123] |                                                                                     | 收到序号为 2 的帧                                    | [1]  |
| [123] |                                                                                     | 此时期望接收到的帧的序号为 1，丢弃                            | [1]  |
| [123] | 超时计时器到期，由于没有收到当前已发送的最后一个帧（即序号为 2 的帧）的确认，重新发送当前发送窗口中的所有帧（即 1 ~ 3），记录当前已发送的最后一个帧序号为 3 |                                               | [1]  |
| [123] |                                                                                     | 收到序号为 1 的帧                                    | [1]  |
| [123] |                                                                                     | 序号为 1 的帧校验正确，向发送方发送序号为 2 的 ACK 确认帧，并移动接收窗口至 2 | [2]  |
| [234] | 收到序号为 1 的确认帧，移动发送窗口前沿至序号 2                                                          |                                               | [2]  |
| [234] |                                                                                     | 收到序号为 2 的帧                                    | [2]  |
| [234] |                                                                                     | 序号为 2 的帧校验正确，向发送方发送序号为 3 的 ACK 确认帧，并移动接收窗口至 3 | [3]  |
| [345] | 收到序号为 2 的确认帧，移动发送窗口前沿至序号 3                                                          |                                               | [3]  |
| [345] |                                                                                     | 收到序号为 3 的帧                                    | [3]  |
| [345] |                                                                                     | 序号为 3 的帧校验正确，向发送方发送序号为 4 的 ACK 确认帧，并移动接收窗口至 4 | [4]  |
| [456] | 收到序号为 3 的确认帧，移动发送窗口前沿至序号 4                                                          |                                               | [4]  |
| [456] | 当前已发送的最后一个帧（即序号为 3 的帧）已收到确认，继续发送当前发送窗口中的所有帧（即 4 ~ 6），并重新启动超时计时器                     |                        
| ...   |                                                                                     |                                               | ...  |

扩展：

+ 发送窗口中的报文可能的状态包括：**已发送但尚未确认**、**已发送且已得到确认（选择确认）**、**已发送但可连续发送**。